# Redis集群主动故障转移（Manual Failover）详解

主动故障转移（也称为手动故障转移）是Redis集群中通过管理员主动发起的故障转移过程，一般用于计划内的维护操作，如升级节点软件、硬件更换等场景。它通过`CLUSTER FAILOVER`命令触发，可以确保数据一致性和平滑过渡。

## 主动故障转移的类型

主动故障转移分为三种模式：

### 1. 标准手动故障转移

通过`CLUSTER FAILOVER`命令触发：

* 从节点向主节点发送MFSTART消息，请求主节点暂停客户端写操作
* 主节点暂停客户端写操作后，向从节点发送带CLUSTERMSG_FLAG0_PAUSED标志的PING消息
* 从节点接收到主节点的复制偏移量，并等待自己的复制偏移量赶上主节点
* 当从节点复制偏移量与主节点一致时，设置mf_can_start标志
* 从节点请求其他主节点投票（类似自动故障转移，但会强制要求其他主节点投票）
* 获得足够投票后，从节点升级为新主节点

### 2. 强制手动故障转移

通过`CLUSTER FAILOVER FORCE`命令触发：

* 跳过与主节点协调的步骤
* 直接设置mf_can_start标志，请求投票
* 其他步骤类似标准手动故障转移
* 适用于主节点仍然可达但响应缓慢的情况

### 3. 接管手动故障转移

通过`CLUSTER FAILOVER TAKEOVER`命令触发：

* 完全跳过投票过程
* 从节点直接生成新的配置纪元
* 接管原主节点的槽位
* 向集群广播新配置
* 适用于集群无法正常工作、无法达成投票多数的紧急情况

## 主动故障转移的客户端暂停机制

在标准手动故障转移过程中，为保证数据一致性，主节点会暂停客户端写入：

* 主节点接收到MFSTART消息后，调用pauseClients()暂停所有客户端写操作
* 客户端请求会被延迟处理，但不会丢失
* 从节点确认复制完成后，会成为新主节点
* 新主节点会解除客户端暂停状态(unpauseClients())
* 该机制确保了所有写操作都被复制到新主节点

## 主动故障转移的超时机制

手动故障转移有多种超时保护机制：

* 如果从节点在请求故障转移后，长时间无法收到主节点带PAUSED标志的PING，会自动取消故障转移
* 如果故障转移过程中断（如网络分区），会有超时机制自动取消故障转移
* 如果从节点等待复制偏移量赶上超时，也会取消故障转移

## 主动故障转移的优势

相比被动故障转移，主动故障转移有以下优势：

1. **数据一致性更高**：等待复制完成，确保不丢失数据
2. **可预测性**：管理员可以选择合适的时间点进行切换
3. **可控性**：可以选择合适的从节点进行提升
4. **无需节点失效**：不需要等待节点被标记为FAIL状态

## 主动故障转移适用场景

1. 计划内维护：如升级Redis版本、硬件更新等
2. 负载均衡：主动调整集群中主节点的分布
3. 网络优化：将主节点迁移到网络条件更好的服务器
4. 故障预防：当监测到主节点可能即将出现问题时提前切换 