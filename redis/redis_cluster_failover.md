# Redis集群故障转移（Failover）详解

Redis集群提供了高可用性的解决方案，通过主从复制和自动故障转移（failover）机制来确保集群的可靠性。当主节点失效时，集群会自动选择一个从节点晋升为新的主节点，继续提供服务。本文将详细分析Redis集群故障转移的流程。

## 故障转移类型

Redis集群中的故障转移分为两种类型：

1. **自动故障转移**：当主节点被标记为故障（FAIL）状态时，自动触发
2. **手动故障转移**：通过`CLUSTER FAILOVER`命令主动触发

## 自动故障转移流程

自动故障转移是Redis集群中保证高可用性的核心机制，以下是详细流程：

### 1. 故障检测

* 集群中的节点通过互相发送PING消息来检测彼此的状态
* 如果节点A发送PING给节点B后，在`cluster-node-timeout`时间内没有收到PONG回复，就会将节点B标记为**PFAIL**（可能故障）状态
* 当半数以上的主节点都认为某个节点处于PFAIL状态时，这个节点会被标记为**FAIL**（确认故障）状态

### 2. 从节点选举

当主节点被标记为FAIL后，它的从节点会争夺成为新主节点的资格：

* 每个从节点会计算自己与主节点断开连接的时间
* 如果断开时间超过`cluster-replica-validity-factor`设置的有效性因子，从节点将不参与选举
* 参与选举的从节点会生成一个failover_auth_time，这个时间包含：
  - 固定延迟（500ms）
  - 随机延迟（0-500ms）
  - 基于从节点排名的延迟（排名×1000ms）

### 3. 投票请求

* 当从节点的failover_auth_time到达时，它会发送FAILOVER_AUTH_REQUEST消息
* 只有处于正常状态的主节点才有投票权
* 从节点会请求集群中所有主节点为自己投票

### 4. 投票过程

* 每个主节点在每个配置纪元(epoch)内只能投票一次
* 主节点会优先考虑给数据较新的从节点投票（根据复制偏移量判断）
* 当某个从节点获得超过半数主节点的投票时，它将赢得选举

### 5. 晋升为主节点

赢得选举的从节点会执行以下操作：

* 更新自己的配置纪元为选举时使用的配置纪元
* 将自己的角色改变为主节点
* 将原主节点负责的槽位指派给自己
* 向集群广播PONG消息，通知集群中的其他节点自己已经成为新的主节点

## 手动故障转移流程

手动故障转移是在特殊情况下（如维护）需要主动将从节点提升为主节点。有三种模式：

### 1. 标准手动故障转移

通过`CLUSTER FAILOVER`命令触发：

* 从节点向主节点发送MFSTART消息，请求主节点暂停客户端写操作
* 主节点暂停客户端写操作后，向从节点发送带CLUSTERMSG_FLAG0_PAUSED标志的PING消息
* 从节点接收到主节点的复制偏移量，并等待自己的复制偏移量赶上主节点
* 当从节点复制偏移量与主节点一致时，设置mf_can_start标志
* 从节点请求其他主节点投票（类似自动故障转移，但会强制要求其他主节点投票）
* 获得足够投票后，从节点升级为新主节点

### 2. 强制手动故障转移

通过`CLUSTER FAILOVER FORCE`命令触发：

* 跳过与主节点协调的步骤
* 直接设置mf_can_start标志，请求投票
* 其他步骤类似标准手动故障转移

### 3. 接管手动故障转移

通过`CLUSTER FAILOVER TAKEOVER`命令触发：

* 完全跳过投票过程
* 从节点直接生成新的配置纪元
* 接管原主节点的槽位
* 向集群广播新配置

## 故障转移中的客户端处理

在故障转移过程中，客户端请求会受到影响：

* 对原主节点的写请求会失败
* 当新主节点完成晋升后，集群会更新槽位映射
* 客户端收到MOVED重定向错误后，会更新自己的槽位映射缓存
* 客户端重新发送请求到新的主节点

## 关键实现细节

1. **配置纪元**：每次故障转移都会增加配置纪元，确保集群配置的单调递增
2. **持久化**：故障转移完成后，新主节点会持久化集群配置
3. **暂停机制**：手动故障转移使用客户端暂停机制保证数据一致性
4. **超时处理**：故障转移有超时机制，避免无限期等待

## 故障转移与数据一致性

Redis集群故障转移是尽力确保数据一致性，但由于Redis的复制是异步的，可能会导致一些数据丢失：

* 在自动故障转移中，如果主节点突然宕机，任何未复制到从节点的写操作都会丢失
* 手动故障转移通过暂停客户端写入和等待复制完成来最小化数据丢失风险 